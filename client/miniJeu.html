<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->


    <!-- Custom styles for this template -->
    <link href="../../css/miniJeu.css" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower|Nunito|Oswald" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Container -->
    <div class="container-fluid">
        <section class="row">
            <h1 >Mini Jeu en 2D</h1>
        </section>
        <section class="row">
            <div id="div-texte" class="col-xs-2">
                <div id="texte">
                    <p style="color:#ff0000"> Joueur 1 : 0</p>
                    <p style="color:#3333ff"> Joueur 2 : 0</p>
                </div>
                <div style='color:#ff0000'>
                    Déplacez vous grâce aux flèches du clavier, et sautez avec la barre d'espace
                </div>

                <div style='color:#3333ff'>
                    Déplacez vous grâce aux touches z, q, s, d, et sautez avec x
                </div>
            </div>

            <div class="hidden-lg"> Ce jeu n'est supporté que sur de grands écrans </div>
            <canvas id="myCanvas" class="col-xs-8 visible-lg" style="overflow:visible" width="1100" height="650"> </canvas>
        </section>
    </div>



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var canvas = document.getElementById("myCanvas");
        var texte = document.getElementById("texte");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffdd99";
        ctx.fillRect(0, 0, canvas.width, canvas.height);


        /*Variables*/

var canvas = document.getElementById("myCanvas");
var texte = document.getElementById("texte");
var ctx = canvas.getContext("2d");

var tailleCase = 25;

var coordPersos = [[0, 0],
          [0,1]];

var score =[0,0];

//6 colonnes et 5 lignes avec le format lÃ  : map[ligne][colonne]
//Initialisation de la map et du foreground


var w = canvas.width/tailleCase;
var h = canvas.height/tailleCase;

var map = mapVide(h, w);
var foreground = mapVide(h,w);

//remplissage map
for(var x=0; x<h; x++){
  for (var y =0; y<w; y++){
    var rand = Math.random();
    //1 herbe 2 foret
    if (rand<0.4)
    {
      map[x][y] = 2;
    }
    else
    {
      map[x][y] = 1;
    }
  }
}

//remplissage foreground
for(x=0; x<h; x++){
  for (y =0; y<w; y++){
    //On remplit alÃ©atoirement
    rand = Math.random();
    //0 rien c caillou (1 j1, 2 j2))
    if (rand<0.1)
    {
      foreground[x][y] = 'c';
    }
    else if (rand<0.2)
          {
      foreground[x][y] = 'b';
    }
          else
          {
      foreground[x][y] = 0;
          }
  }
}

var couleurHerbe = "#00e600"
var couleurForet =  "#00b33c";
var couleurCaillou = "#996633";
var couleurBonbon = "#ffcc00";
var couleurj1 = "#ff0000";
var couleurj2 = "#3333ff";


/*Fonctions*/

function mapVide(xMax, yMax){
  var map = [];
  for(var x=0; x<xMax; x++){
    map[x]=[];
    for(var y=0; y<yMax; y++){
      map[x][y]=0;
    }
  }
  return map;
}


function initialiserPerso(numPerso){
  var xPerso = coordPersos[numPerso-1][0];
  var yPerso =  coordPersos[numPerso-1][1];
  foreground[yPerso][xPerso] = numPerso;
}

function dessiner(x, y, couleur){
  ctx.fillStyle = couleur;
  ctx.fillRect(x, y, tailleCase, tailleCase);
  ctx.stroke();
}

//Est ce que le personnage peut effectuer le dÃ©placement vers xPerso+deltaX et yPerso+deltaY
function mouvementPossible(deltaX, deltaY, numPerso)
{
  var xPerso = coordPersos[numPerso-1][0];
  var yPerso =  coordPersos[numPerso-1][1];

  var pasArriveFin =  ((xPerso+deltaX<=(w-1))&&(yPerso+deltaY<=(h-1))) ;
  var pasArriveDebut =  ((xPerso+deltaX>=0)&&(yPerso+deltaY>=0));

  var surDuVide = ((foreground[yPerso+deltaY][xPerso+deltaX]) == 0);
  var surUnBonbon = ((foreground[yPerso+deltaY][xPerso+deltaX]) == 'b');

      if (surUnBonbon){
              score[numPerso-1]++;
              majScore();
      }

  return pasArriveDebut && pasArriveFin && (surDuVide||surUnBonbon) ;
}


function avancer(deltaX, deltaY, numPerso){
  //On rÃ©cupÃ¨re les coordonnÃ©es du joueur dans le tableau coordPersos
  var xPerso = coordPersos[numPerso-1][0];
  var yPerso =  coordPersos[numPerso-1][1];

  //texte.innerHTML = "On dessine j" + numPerso + " qui est en ("+xPerso + ", " + yPerso + ") et qui veut aller en (" + (xPerso+deltaX) + ", " + (yPerso+deltaY) + ").";
  //On vÃ©rifie qu'il ne rentre pas dans un caillou ni un autre joueur
  if (mouvementPossible(deltaX, deltaY, numPerso)){
    //On redessine la map vide
    dessinerMap();


    //On efface le personnage
    foreground[yPerso][xPerso] = 0;

    //On prends en compte le dÃ©placement
    xPerso= xPerso+deltaX;
    yPerso= yPerso+deltaY;

    //On re-ecrit le personnage
    foreground[yPerso][xPerso] = numPerso;

    //On enregistre les nouvelles coordonnÃ©es
    coordPersos[numPerso-1][0]=xPerso;
    coordPersos[numPerso-1][1]=yPerso;


    //On affiche les changements
    dessinerForeground();
  }
}

  function majScore(){
      texte.innerHTML = "<p style='color:"+couleurj1+"'> Joueur 1 : "+score[0]+"</p>"+
                          "<p style='color:"+couleurj2+"'> Joueur 2 : "+score[1]+"</p>";
  }

//Dessin de la map
function dessinerMap(){
  for(var x=0; x<h; x++){
    for (var y =0; y<w; y++){
        var value = map[x][y];
        switch(value){
          case (0):
            break;
          case(1):
            dessiner(tailleCase*y, tailleCase*x, couleurHerbe);
            break;
          case(2):
            dessiner(tailleCase*y, tailleCase*x, couleurForet);
            break;
        }
      }
    }
}

function dessinerForeground(){
  for(var x=0; x<h; x++){
    for (var y =0; y<w; y++){
      var value = foreground[x][y];
      switch(value){
        case (0):
          break;
        case(1):
          dessiner(tailleCase*y, tailleCase*x, couleurj1);
          break;
        case(2):
          dessiner(tailleCase*y, tailleCase*x, couleurj2);
          break;
        case('c'):
          dessiner(tailleCase*y, tailleCase*x, couleurCaillou);
          break;
        case('b'):
          dessiner(tailleCase*y, tailleCase*x, couleurBonbon);
          break;
      }
    }
  }
}


/*DÃ©but du jeu*/

initialiserPerso(1);
initialiserPerso(2);
dessinerMap();
dessinerForeground();


/*Event listener*/
  window.addEventListener("keydown", function(e){
  var code =  e.keyCode;

  switch (code){
    /*PREMIER JOUEUR*/
    //32:barre d'espace, le personnage "saute"
    case (32):
      avancer(0,(-2), 1);
      break;
    //37:fleche gauche, le personnage va vers la gauche
    case (37):
      avancer((-1),0, 1);
      break;
    //38:fleche du haut, le personnage va vers le haut
    case (38):
      avancer(0,(-1), 1);
      break;
    //37:fleche droite, le personnage va vers la droite
    case (39):
      avancer(1,0, 1);
      break;
    //37:fleche du bas, le personnage va vers le bas
    case (40):
      avancer(0,1, 1);
      break;

    /*DEUXIEME JOUEUR*/
    //88:x, le personnage saute
    case(88):
      avancer(0,(-2), 2);
      break;
    //90: z, le personnage va vers le haut
    case(90):
      avancer(0,(-1), 2);
      break;
    //68:d, vers la droite
    case(68):
      avancer(1,0, 2);
      break;
    //83:s, vers le bas
    case (83):
      avancer(0,1, 2);
      break;
    //81:q, gauche
    case (81):
      avancer((-1),0, 2);
      break;

  }
}, false);

    </script>

    <script type="text/javascript" src="../../js/miniJeu.js"></script>



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins)-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
</body>

</html>
